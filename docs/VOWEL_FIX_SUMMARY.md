# 母音判別問題の修正内容

## 実施した修正

### ✅ 1. 動的キャリブレーション機能の追加

**問題**: 固定値（1.0）で正規化していたため、実際の計測値（0.01-0.1程度）が正規化されず、「い」にしか判定されなかった

**修正内容**:
- トラッキング開始時に、最初の3秒間（90フレーム）で最大値を記録
- その最大値を基準値として使用して正規化
- 20%のマージンを追加して、より大きな口の開きにも対応

```javascript
// キャリブレーション中は最大値を記録
if (this.isCalibrating) {
    this.userBaseline.maxOpenness = Math.max(
        this.userBaseline.maxOpenness, 
        metrics.openness
    );
    // ...
}
```

### ✅ 2. デバッグログの追加

実際の計測値を確認できるように、最初の10フレームの計測値をコンソールに出力：

```javascript
console.log(`[Frame ${frame}] 計測値:`, {
    raw: { openness, width, aspectRatio },
    normalized: { normOpenness, normWidth, aspectRatio },
    baseline: userBaseline,
    scores: scores,
    vowel: vowel,
    confidence: confidence
});
```

### ✅ 3. 正規化ロジックの改善

- 基準値が0の場合は正規化せずにそのまま使用（フォールバック）
- 正規化後の値が2.0を超えないように制限

```javascript
const normOpenness = this.userBaseline.maxOpenness > 0.001 
    ? Math.min(metrics.openness / this.userBaseline.maxOpenness, 2.0)
    : metrics.openness;
```

### ✅ 4. UI改善

- キャリブレーション中の進捗を表示
- キャリブレーション完了時に通知

## 使用方法

### 重要な注意点

**キャリブレーション中は、口を様々な形に動かしてください**：
1. 口を大きく開く（「あ」の形）
2. 口を横に広げる（「い」の形）
3. 口をすぼめる（「う」の形）
4. 口を少し開いて横に広げる（「え」の形）
5. 口を丸く開ける（「お」の形）

これにより、システムが各母音の最大値を記録し、正確な判別が可能になります。

### デバッグ方法

1. ブラウザの開発者ツール（F12）を開く
2. コンソールタブを選択
3. トラッキングを開始
4. 最初の10フレームの計測値を確認
5. キャリブレーション完了後の判別結果を確認

## 期待される動作

### 修正前
- 口を開けても「い」にしかならない
- 正規化が機能していない（固定値1.0で割っている）

### 修正後
- キャリブレーション中（最初の3秒）は最大値を記録
- キャリブレーション完了後、動的に設定された基準値で正規化
- 各母音を正確に判別可能

## 今後の改善

1. **キャリブレーションの改善**
   - ユーザーに各母音を発音してもらうガイドを表示
   - キャリブレーションの精度を向上

2. **閾値の調整**
   - 実際の計測値の範囲を確認後、必要に応じて閾値を調整

3. **相対的な判定の追加**
   - アスペクト比などの相対的な特徴量をより重視

## トラブルシューティング

### 問題: まだ「い」にしかならない

**確認事項**:
1. キャリブレーション中に口を大きく開いたか
2. コンソールの計測値を確認（`raw.openness`の値）
3. 基準値が正しく設定されているか（`baseline.maxOpenness`）

**対処法**:
- キャリブレーションをリセット: `vowelClassifier.resetCalibration()`
- 手動で基準値を設定: `vowelClassifier.setUserBaseline({ maxOpenness: 0.1, maxWidth: 0.15 })`

### 問題: キャリブレーションが完了しない

**確認事項**:
1. 顔が検出されているか
2. 計測値が取得されているか（`data.metrics`が存在するか）

**対処法**:
- カメラに向かって顔を映す
- 十分な照明を確保

