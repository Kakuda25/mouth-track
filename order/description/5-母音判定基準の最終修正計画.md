# 母音判定基準の最終修正計画

## 修正後の新たな問題

### 報告された問題

1. **閉口状態で「え」が判定される（再発）**
   - カメラ起動し唇をつけている状態で「え」の判定が出る
   - 前回の修正で改善したはずの問題が再発

2. **口を開くと「あ」としてしか判定されない**
   - 「い」「う」「え」「お」が判定されない
   - 「あ」のみが判定される

3. **口を隠すと閉口判定（正常）**
   - 口を隠した場合は正しく閉口判定される

## 問題の原因分析

### 1. 閉口判定が緩すぎる（再発）

**現在の閉口判定ロジック:**
```javascript
_isMouthClosed(metrics) {
  // 絶対閾値: openness <= 0.012 → 閉口
  if (openness <= 0.012) {
    return true;
  }

  // 厚み比率: openness <= 0.02 && thicknessRatio > 0.25 → 閉口
  if (openness <= 0.02 && thicknessRatio > 0.25) {
    return true;
  }
  
  // キャリブレーション基準: openness <= baseline.openness * 1.3 → 閉口
  // デフォルト閾値: openness <= 0.012 → 閉口
}
```

**問題点:**
- 前回の修正で閉口判定を厳格化（0.015→0.012）したが、逆に緩すぎる可能性がある
- 「え」の`openness.min`は`0.03`なので、`openness = 0.012-0.03`の範囲で閉口判定を通過してしまう
- 閉口状態（唇をつけている）で`openness`が`0.012`を超える場合、閉口判定を通過し「え」が判定される

### 2. 「え」のペナルティが緩すぎる

**現在の「え」のペナルティ:**
```javascript
if (aspectRatio < config.aspectRatio.penaltyThreshold) return combined * 0.4;  // 2.0未満
if (openness < config.openness.min) return combined * 0.15;  // 0.03未満
if (openness > config.openness.max) return combined * 0.4;  // 0.06超過
if (openness < 0.035) {
  return combined * 0.4;
}
```

**問題点:**
- `openness < 0.03`（閉口に近い）の場合、ペナルティは×0.15
- しかし、`openness = 0.015-0.03`の範囲では、まだスコアが残る可能性がある
- 閉口に近い状態で「え」のスコアが他の母音より高くなる

### 3. ペナルティの緩和が過度だった

**前回の修正でペナルティを緩和:**
- 「い」: 0.2→0.25、0.3→0.4、0.5→0.6
- 「う」: 0.15→0.2、0.3→0.4、0.4→0.5
- 「え」: 0.3→0.4、0.1→0.15、0.3→0.4
- 「お」: 0.2→0.3、0.4→0.5

**問題点:**
- ペナルティを緩和しすぎて、「あ」以外の母音のスコアが上がりすぎた
- 特に「え」は閉口に近い状態でもスコアが高くなる

### 4. 最小スコア閾値が低すぎる

**現在の最小スコア閾値:**
```javascript
const minScoreThreshold = metrics.openness < 0.03 ? 0.4 : 0.25;
```

**問題点:**
- `openness < 0.03`の場合、閾値は`0.4`
- しかし、「え」は閉口に近い状態でもスコアが`0.4`を超える可能性がある
- 閾値が低すぎて、誤判定を防げない

## 修正計画

### フェーズ1: 閉口判定の再強化

#### 1.1 閉口判定の閾値を調整

**現在:**
```javascript
if (openness <= 0.012) {
  return true;
}

if (openness <= 0.02 && thicknessRatio > 0.25) {
  return true;
}
```

**修正案:**
```javascript
// 絶対閾値を上げる: 0.012 → 0.018
if (openness <= 0.018) {
  return true;
}

// 厚み比率判定を緩和: 0.02 → 0.028
if (openness <= 0.028 && thicknessRatio > 0.25) {
  return true;
}
```

**変更点:**
- 絶対閾値を`0.012`→`0.018`に上げる（閉口判定の範囲を広げる）
- 厚み比率判定の閾値を`0.02`→`0.028`に上げる
- これにより、閉口状態で「え」が判定されにくくなる

#### 1.2 閉口判定の設定値を更新

**修正案:**
```javascript
this.thresholds = {
  closed: {
    openness: 0.018,        // 0.012 → 0.018
    opennessRatio: 1.4      // 1.3 → 1.4 (より緩やかに)
  },
  // ...
}
```

### フェーズ2: 「え」のペナルティ再強化

#### 2.1 「え」のスコア計算の修正

**現在:**
```javascript
if (aspectRatio < config.aspectRatio.penaltyThreshold) return combined * 0.4;
if (openness < config.openness.min) return combined * 0.15;
if (openness > config.openness.max) return combined * 0.4;
if (openness < 0.035) {
  return combined * 0.4;
}
```

**修正案:**
```javascript
if (aspectRatio < config.aspectRatio.penaltyThreshold) return combined * 0.35;
if (openness < config.openness.min) return combined * 0.08;  // 0.15 → 0.08 (より強く)
if (openness > config.openness.max) return combined * 0.35;
if (openness < 0.04) {  // 0.035 → 0.04
  return combined * 0.35;
}
```

**変更点:**
- `openness < 0.03`（閉口に近い）のペナルティを×0.15→×0.08に強化
- 他のペナルティも若干強化（0.4→0.35）
- 閉口に近い状態の閾値を`0.035`→`0.04`に戻す

### フェーズ3: 最小スコア閾値の調整

#### 3.1 動的閾値の再調整

**現在:**
```javascript
const minScoreThreshold = metrics.openness < 0.03 ? 0.4 : 0.25;
```

**修正案:**
```javascript
// 閾値を上げる
const minScoreThreshold = metrics.openness < 0.04 ? 0.45 : 0.28;
```

**変更点:**
- `openness < 0.04`（より広い範囲）で高い閾値を適用
- 閾値を`0.4`→`0.45`、`0.25`→`0.28`に上げる

### フェーズ4: 他の母音のペナルティ微調整

#### 4.1 「い」のペナルティ調整

**現在:**
```javascript
if (aspectRatio < config.aspectRatio.min) return combined * 0.25;
if (openness > config.openness.penaltyThreshold) return combined * 0.4;
if (openness < 0.035) {
  return combined * 0.6;
}
```

**修正案:**
```javascript
if (aspectRatio < config.aspectRatio.min) return combined * 0.22;
if (openness > config.openness.penaltyThreshold) return combined * 0.38;
if (openness < 0.04) {  // 0.035 → 0.04
  return combined * 0.55;
}
```

**変更点:**
- ペナルティを若干強化（0.25→0.22、0.4→0.38、0.6→0.55）
- 閉口に近い状態の閾値を`0.035`→`0.04`に戻す

#### 4.2 「う」のペナルティ調整

**現在:**
```javascript
if (width > config.width.penaltyThreshold) return combined * 0.2;
if (circularity < config.circularity.penaltyThreshold) return combined * 0.4;
if (openness < 0.035) {
  return combined * 0.5;
}
```

**修正案:**
```javascript
if (width > config.width.penaltyThreshold) return combined * 0.18;
if (circularity < config.circularity.penaltyThreshold) return combined * 0.38;
if (openness < 0.04) {  // 0.035 → 0.04
  return combined * 0.48;
}
```

**変更点:**
- ペナルティを若干強化（0.2→0.18、0.4→0.38、0.5→0.48）
- 閉口に近い状態の閾値を`0.035`→`0.04`に戻す

#### 4.3 「お」のペナルティ調整

**現在:**
```javascript
if (circularity < config.circularity.penaltyThreshold) return combined * 0.3;
if (openness < 0.045) {
  return combined * 0.5;
}
```

**修正案:**
```javascript
if (circularity < config.circularity.penaltyThreshold) return combined * 0.28;
if (openness < 0.05) {  // 0.045 → 0.05
  return combined * 0.48;
}
```

**変更点:**
- ペナルティを若干強化（0.3→0.28、0.5→0.48）
- 閉口に近い状態の閾値を`0.045`→`0.05`に戻す

### フェーズ5: 「あ」のペナルティ微調整

#### 5.1 「あ」のペナルティを若干緩和

**現在:**
```javascript
if (openness < config.openness.penaltyThreshold) { // 0.08
  const penaltyFactor = Math.max(0.15, openness / config.openness.penaltyThreshold);
  return combined * penaltyFactor * 0.35;
}

if (openness < 0.08) {
  return combined * 0.75;
}
```

**修正案:**
```javascript
if (openness < config.openness.penaltyThreshold) { // 0.08
  const penaltyFactor = Math.max(0.18, openness / config.openness.penaltyThreshold);
  return combined * penaltyFactor * 0.38;
}

if (openness < 0.08) {
  return combined * 0.78;
}
```

**変更点:**
- `penaltyFactor`の最小値を`0.15`→`0.18`に上げる
- ペナルティ倍率を`0.35`→`0.38`に上げる
- 軽いペナルティを`0.75`→`0.78`に緩和
- 「あ」のスコアを若干上げて、他の母音とのバランスを取る

## 実装順序

### ステップ1: 閉口判定の再強化（最優先）
1. 閉口判定の閾値を調整（0.012→0.018、0.02→0.028）
2. `closed`閾値の更新
3. テスト: 閉口状態で「え」が判定されないことを確認

### ステップ2: 「え」のペナルティ再強化
1. 「え」のペナルティを強化（特に`openness < 0.03`）
2. テスト: 閉口に近い状態で「え」が判定されないことを確認

### ステップ3: 最小スコア閾値の調整
1. 最小スコア閾値を上げる（0.4→0.45、0.25→0.28）
2. テスト: 誤判定が減ることを確認

### ステップ4: 他の母音のペナルティ微調整
1. 「い」「う」「お」のペナルティを若干強化
2. テスト: 各母音が正しく判定されることを確認

### ステップ5: 「あ」のペナルティ微調整
1. 「あ」のペナルティを若干緩和してバランスを取る
2. テスト: 「あ」が正しく判定されることを確認

## 期待される効果

### 修正後の動作

1. **閉口判定の改善:**
   - 閉口状態（唇をつけている状態）で「え」が判定されなくなる
   - 閉口判定の精度が向上

2. **母音判定の改善:**
   - 「い」「う」「え」「お」が正しく判定される
   - 「あ」としてしか判定されない問題が解決

3. **全体的な判定精度の向上:**
   - 各母音が適切な条件で判定される
   - 誤検出が減少

## テスト計画

### テストケース1: 閉口状態の判定
- **条件**: カメラ起動し、唇をつけている状態
- **期待結果**: 「閉口」が判定される（「え」が判定されない）

### テストケース2: 各母音の判定
- **条件**: 各母音を発音
- **期待結果**: 
  - 「あ」: 正しく判定される
  - 「い」: 正しく判定される（「あ」として判定されない）
  - 「う」: 正しく判定される（「あ」として判定されない）
  - 「え」: 正しく判定される（「あ」として判定されない）
  - 「お」: 正しく判定される（「あ」として判定されない）

### テストケース3: 口を隠した場合の判定
- **条件**: 口を隠す
- **期待結果**: 「閉口」が判定される（正常）

## 問題の根本原因

### 前回の修正の問題点

前回の修正では：

1. **閉口判定を厳格化しすぎた:**
   - 閾値を`0.015`→`0.012`に下げた
   - これにより、閉口判定を通過する範囲が狭くなりすぎた
   - 結果として、閉口に近い状態で「え」が判定される

2. **ペナルティを緩和しすぎた:**
   - 「え」のペナルティを緩和（0.1→0.15）
   - これにより、閉口に近い状態でも「え」のスコアが高くなる

3. **最小スコア閾値を下げすぎた:**
   - 閾値を`0.5`→`0.4`、`0.3`→`0.25`に下げた
   - これにより、誤判定を防げなくなった

### 今回の修正の方針

1. **閉口判定を適切に調整:**
   - 閾値を`0.012`→`0.018`に上げる（閉口判定の範囲を広げる）
   - 閉口状態で「え」が判定されないようにする

2. **「え」のペナルティを再強化:**
   - 特に`openness < 0.03`（閉口に近い）のペナルティを強化
   - 閉口に近い状態で「え」のスコアを下げる

3. **最小スコア閾値を適切に調整:**
   - 閾値を`0.4`→`0.45`、`0.25`→`0.28`に上げる
   - 誤判定を防ぐ

4. **バランスを取る:**
   - 他の母音のペナルティも若干調整
   - 「あ」のペナルティを若干緩和してバランスを取る

## 注意事項

1. **段階的な実装:**
   - 一度にすべてを変更せず、ステップごとに実装・テストする
   - 各ステップで動作確認を行う

2. **閾値の調整:**
   - 閾値は実際の計測値に基づいて調整する必要がある
   - ユーザーごとに最適値が異なる可能性がある

3. **ペナルティのバランス:**
   - ペナルティを調整しすぎると、他の問題が発生する可能性がある
   - 各母音のバランスを見ながら調整する

4. **ログの記録:**
   - 修正前後の計測値と判定結果を記録
   - 問題が発生した場合の原因調査に活用

## 関連ファイル

- `module/core/VowelClassifier.js`: 母音判定の実装
- `order/description/4-母音判定基準の再修正計画.md`: 前回の再修正計画
- `order/description/3-母音判定基準の修正計画.md`: 前々回の修正計画
- `order/description/2-母音検知の数値調整とドキュメント作成.md`: 詳細仕様

