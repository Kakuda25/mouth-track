# 母音検知の詳細仕様と数値調整ガイド

## 概要

本ドキュメントは、`VowelClassifier`クラスで実装されている母音判定ロジックの詳細を記述し、数値調整のための指針を提供します。

## 判定フロー

```
入力: metrics (正規化済み計測値) + temporalFeatures (時系列特徴量)
  ↓
1. 必須項目チェック (openness, width, aspectRatio)
  ↓
2. 閉口判定 (_isMouthClosed)
  ├─ 閉口 → 'closed' を返す
  └─ 開口 → 次へ
  ↓
3. 各母音のスコア計算 (_scoreForA, _scoreForI, _scoreForU, _scoreForE, _scoreForO)
  ↓
4. 最大スコアが0.3未満 → null を返す
  ↓
5. 最大スコアの母音を選択
  ↓
6. 確率計算 (各スコア / 合計スコア)
  ↓
7. 時系列平滑化 (_smoothVowel: 最新7フレームの多数決)
  ↓
8. 遷移ペナルティ適用 (_transitionPenalty)
  ↓
出力: { vowel, confidence, probabilities, scores, metrics }
```

## 使用されている計測項目

### 基本項目（全母音で使用）

| 項目名 | 説明 | 計算方法 | 単位 |
|--------|------|----------|------|
| `openness` | 口の開き具合 | 上唇中央(13)と下唇中央(14)の距離 | 正規化距離 |
| `width` | 口の幅 | 左口角(61)と右口角(291)の距離 | 正規化距離 |
| `aspectRatio` | アスペクト比 | `width / openness` | 無次元 |
| `area` | 口の面積 | `π * (width/2) * (openness/2)` | 正規化面積 |

### 拡張項目（特定の母音で使用）

| 項目名 | 説明 | 計算方法 | 使用母音 |
|--------|------|----------|----------|
| `circularity` | 円形度 | `4π * area / perimeter²` | う, お |
| `upperLipThickness` | 上唇の厚さ | 上唇外側と内側の平均距離 | い, え, お |
| `lowerLipThickness` | 下唇の厚さ | 下唇外側と内側の平均距離 | い, え, お |
| `mouthCornerAngle` | 口角の角度 | 口角の上下方向の角度 | い, え |
| `lipProtrusion` | 唇の突出度 | 上唇外側のZ座標平均 | う, お |
| `lipThicknessRatio` | 唇厚/幅比 | `(上唇厚 + 下唇厚) / width` | い |
| `lipThicknessGap` | 上下唇の厚さ差 | `|上唇厚 - 下唇厚|` | え |
| `thicknessRatio` | 幅/厚み比 | `width / (上唇厚 + 下唇厚)` | お |

## 各母音の判定ロジック

### あ (a)

**使用項目と重み付け:**
- `openness`: 65% (最重要)
- `aspectRatio`: 25%
- `area`: 10%

**閾値設定:**
```javascript
{
  openness: {
    optimal: 0.10,        // 最適値（ガウス分布の中心）
    sigma: 0.03,          // 標準偏差
    penaltyThreshold: 0.06  // これ未満でペナルティ（スコア×0.3）
  },
  aspectRatio: {
    min: 0.8,             // 最小値
    max: 1.8,             // 最大値
    falloffRange: 2.5     // 範囲外での減衰率
  },
  area: {
    max: 0.025            // 最大面積
  }
}
```

**スコア計算:**
1. `openness`をガウス分布で評価（最適値0.10、σ=0.03）
2. `aspectRatio`をクランプ比で評価（0.8-1.8の範囲で1.0、範囲外で減衰）
3. `area`を正規化（`area / 0.025`で上限1.0）
4. 重み付け合計: `openScore * 0.65 + aspectScore * 0.25 + areaScore * 0.1`
5. `openness < 0.06`の場合、スコアを0.3倍に減衰

**判断のポイント:**
- 大きく開いた口が特徴
- `openness`が最重要で、0.10付近が最適
- `aspectRatio`は1.0前後（横長でも縦長でもない）

---

### い (i)

**使用項目と重み付け:**
- `aspectRatio`: 45% (最重要)
- `openness`: 25%
- `width`: 15%
- `mouthCornerAngle`: 10%
- `lipThicknessRatio`: 5%

**閾値設定:**
```javascript
{
  aspectRatio: {
    optimal: 6.5,         // 最適値（横長）
    sigma: 1.5,          // 標準偏差
    min: 4.0             // 最小値（これ未満でスコア×0.3）
  },
  openness: {
    max: 0.04,           // 最大値
    penaltyThreshold: 0.05  // これ超過でスコア×0.5
  },
  width: {
    min: 0.08,           // 最小値
    range: 0.05          // 範囲（min以上で線形増加）
  },
  mouthCornerAngle: {
    max: 0.25            // 最大角度（ラジアン）
  },
  lipThicknessRatio: {
    optimal: 0.12,       // 最適値
    sigma: 0.06          // 標準偏差
  }
}
```

**スコア計算:**
1. `aspectRatio`をガウス分布で評価（最適値6.5、σ=1.5）
2. `openness`を上限評価（0.04未満で1.0、超過で減衰）
3. `width`を範囲評価（0.08以上で線形増加）
4. `mouthCornerAngle`を角度評価（角度が小さいほど高スコア）
5. `lipThicknessRatio`をガウス分布で評価（最適値0.12、σ=0.06）
6. 重み付け合計
7. `aspectRatio < 4.0`の場合、スコアを0.3倍に減衰
8. `openness > 0.05`の場合、スコアを0.5倍に減衰

**判断のポイント:**
- 横に広がった口が特徴（`aspectRatio`が高い）
- `openness`は小さい（0.04未満が理想）
- 口角が上がらない（角度が小さい）

---

### う (u)

**使用項目と重み付け:**
- `width`: 30%
- `circularity`: 30%
- `openness`: 20%
- `aspectRatio`: 10%
- `lipProtrusion`: 10%

**閾値設定:**
```javascript
{
  width: {
    max: 0.05,           // 最大値
    penaltyThreshold: 0.06  // これ超過でスコア×0.25
  },
  circularity: {
    min: 0.45,           // 最小値
    penaltyThreshold: 0.35  // これ未満でスコア×0.5
  },
  openness: {
    max: 0.05,           // 最大値
    sigma: 0.02          // 標準偏差（超過時の減衰）
  },
  aspectRatio: {
    min: 1.0,            // 最小値
    max: 2.4             // 最大値
  },
  lipProtrusion: {
    max: 0.012           // 最大突出度
  }
}
```

**スコア計算:**
1. `width`を上限評価（0.05未満で1.0、超過で減衰）
2. `circularity`をそのまま使用（0.0-1.0）
3. `openness`を上限評価（0.05未満で1.0、超過で減衰）
4. `aspectRatio`を範囲評価（1.0-2.4の範囲で1.0、範囲外で0.6）
5. `lipProtrusion`を正規化（`lipProtrusion / 0.012`で上限1.0、未定義時0.4）
6. 重み付け合計
7. `width > 0.06`の場合、スコアを0.25倍に減衰
8. `circularity < 0.35`の場合、スコアを0.5倍に減衰

**判断のポイント:**
- 小さく丸い口が特徴（`width`が小さい、`circularity`が高い）
- `openness`は小さい（0.05未満）
- 唇が前に出る（`lipProtrusion`が高い）

---

### え (e)

**使用項目と重み付け:**
- `aspectRatio`: 35% (最重要)
- `openness`: 30%
- `width`: 15%
- `mouthCornerAngle`: 10%
- `lipThicknessGap`: 10%

**閾値設定:**
```javascript
{
  aspectRatio: {
    optimal: 3.0,        // 最適値
    sigma: 1.0,          // 標準偏差
    penaltyThreshold: 2.0  // これ未満でスコア×0.5
  },
  openness: {
    min: 0.03,           // 最小値
    optimal: 0.045,      // 最適値
    sigma: 0.015,        // 標準偏差
    max: 0.06            // 最大値
  },
  width: {
    min: 0.08,           // 最小値
    range: 0.05          // 範囲
  },
  mouthCornerAngle: {
    max: 0.28            // 最大角度
  },
  lipThicknessGap: {
    optimal: 0.008,      // 最適値（上下唇の厚さ差が小さい）
    sigma: 0.008         // 標準偏差
  }
}
```

**スコア計算:**
1. `aspectRatio`をガウス分布で評価（最適値3.0、σ=1.0）
2. `openness`をガウス分布で評価（最適値0.045、σ=0.015）
3. `width`を範囲評価（0.08以上で線形増加、未満で0.4）
4. `mouthCornerAngle`を角度評価（角度が小さいほど高スコア）
5. `lipThicknessGap`をガウス分布で評価（最適値0.008、σ=0.008）
6. 重み付け合計
7. `aspectRatio < 2.0`の場合、スコアを0.5倍に減衰
8. `openness < 0.03`の場合、スコアを0.2倍に減衰（閉口に近い）
9. `openness > 0.06`の場合、スコアを0.5倍に減衰

**判断のポイント:**
- 中程度に開いた横長の口（`aspectRatio`が3.0前後、`openness`が0.045前後）
- `openness`が小さすぎると強く減衰（閉口判定との区別）
- 上下唇の厚さがほぼ同じ（`lipThicknessGap`が小さい）

---

### お (o)

**使用項目と重み付け:**
- `circularity`: 35% (最重要)
- `thicknessRatio`: 25%
- `openness`: 15%
- `width`: 15%
- `lipProtrusion`: 10%

**閾値設定:**
```javascript
{
  circularity: {
    min: 0.45,           // 最小値
    penaltyThreshold: 0.38  // これ未満でスコア×0.4
  },
  width: {
    optimal: 0.07,       // 最適値
    sigma: 0.02          // 標準偏差
  },
  lipProtrusion: {
    max: 0.015           // 最大突出度
  },
  thicknessRatio: {
    optimal: 4.0,        // 最適値（幅/厚み比）
    sigma: 1.5           // 標準偏差
  },
  openness: {
    optimal: 0.055,      // 最適値
    sigma: 0.02          // 標準偏差
  }
}
```

**スコア計算:**
1. `circularity`をそのまま使用（0.0-1.0）
2. `thicknessRatio`をガウス分布で評価（最適値4.0、σ=1.5）
3. `openness`をガウス分布で評価（最適値0.055、σ=0.02）
4. `width`をガウス分布で評価（最適値0.07、σ=0.02）
5. `lipProtrusion`を正規化（`lipProtrusion / 0.015`で上限1.0、未定義時0.4）
6. 重み付け合計
7. `circularity < 0.38`の場合、スコアを0.4倍に減衰

**判断のポイント:**
- 丸い口が特徴（`circularity`が高い）
- 中程度の開き（`openness`が0.055前後）
- 幅と厚みの比が適切（`thicknessRatio`が4.0前後）
- 唇が前に出る（`lipProtrusion`が高い）

---

## 閉口判定 (_isMouthClosed)

**判定条件（優先順位順）:**

1. **絶対閾値判定:**
   - `openness <= 0.02` → 即座に閉口

2. **厚み比率判定:**
   - `openness <= 0.03` かつ `(上唇厚 + 下唇厚) / width > 0.25` → 閉口
   - 口が小さく開いていても、唇の厚みが幅に対して大きい場合は閉口扱い

3. **キャリブレーション基準判定:**
   - キャリブレーション済みの場合: `openness <= baseline.openness * 1.5` → 閉口
   - デフォルト: `openness <= 0.015` → 閉口

4. **特殊ケース:**
   - `openness <= 0.025` かつ `aspectRatio > 8.0` → 閉口ではない（横に広がっている場合は開口扱い）

**閾値設定:**
```javascript
{
  closed: {
    openness: 0.015,        // デフォルト閉口閾値
    opennessRatio: 1.5      // キャリブレーション基準の倍率
  }
}
```

---

## 時系列平滑化

### 多数決平滑化 (_smoothVowel)

- **履歴長:** 最新7フレーム
- **方法:** 履歴内で最も多く出現した母音を選択
- **信頼度:** 選択された母音の平均信頼度を計算

### 遷移ペナルティ (_transitionPenalty)

口の動きが激しい場合（母音の遷移中）は信頼度を減衰:

```javascript
velocitySum = |openness.velocity| + |width.velocity|
accSum = |openness.acceleration| + |width.acceleration|

if (velocitySum > 0.35 || accSum > 0.7) → confidence × 0.7
else if (velocitySum > 0.18 || accSum > 0.35) → confidence × 0.85
else → confidence × 1.0
```

---

## 数値調整の指針

### 一般的な調整方法

1. **閾値の調整:**
   - `optimal`: ガウス分布の中心。最適値を変更
   - `sigma`: ガウス分布の広がり。大きいほど緩い判定
   - `min`/`max`: 範囲判定の境界
   - `penaltyThreshold`: ペナルティが適用される境界

2. **重み付けの調整:**
   - 各項目の重み（%）を変更することで、どの項目を重視するかを調整
   - 合計が100%になるように調整

3. **ペナルティの調整:**
   - ペナルティ倍率（0.2, 0.3, 0.5など）を変更
   - ペナルティ閾値を変更

### 問題別の調整例

#### 「あ」が誤検出される場合

- `a.openness.optimal`を下げる（例: 0.10 → 0.08）
- `a.openness.sigma`を小さくする（例: 0.03 → 0.02）
- `a.openness.penaltyThreshold`を上げる（例: 0.06 → 0.08）

#### 「い」が検出されない場合

- `i.aspectRatio.optimal`を下げる（例: 6.5 → 5.5）
- `i.aspectRatio.min`を下げる（例: 4.0 → 3.5）
- `i.openness.max`を上げる（例: 0.04 → 0.05）

#### 「う」と「お」が混同される場合

- `u.circularity.min`を上げる（例: 0.45 → 0.50）
- `o.circularity.min`を上げる（例: 0.45 → 0.50）
- `u.lipProtrusion.max`と`o.lipProtrusion.max`の差を明確にする

#### 閉口が誤検出される場合

- `closed.openness`を下げる（例: 0.015 → 0.012）
- `closed.opennessRatio`を下げる（例: 1.5 → 1.3）

#### 遷移時の誤検出が多い場合

- `_transitionPenalty`の閾値を下げる（より早くペナルティを適用）
- `historyLength`を増やす（例: 7 → 10）

### 調整の手順

1. **問題の特定:**
   - どの母音が誤検出されているか
   - どのような状況で誤検出が発生するか

2. **関連する項目の確認:**
   - 誤検出されている母音の判定項目を確認
   - 実際の計測値と閾値を比較

3. **段階的な調整:**
   - 一度に大幅に変更せず、小さなステップで調整
   - 各調整後にテストを実施

4. **ログの記録:**
   - 調整前後の閾値を記録
   - テスト結果を記録

---

## 実装上の注意点

### 正規化について

- すべての距離系特徴量（`openness`, `width`, `area`など）は顔スケールで正規化済み
- 顔スケールは`DataProcessor.calculateFaceScale()`で計算（目の距離または顔の高さ）
- 正規化により、カメラとの距離や顔のサイズに依存しない判定が可能

### キャリブレーション

- `CalibrationManager`で閉口状態をサンプリング
- `baseline.openness`などを`VowelClassifier.setBaseline()`で設定
- ユーザー固有の適応には`calibrationProfiles`を使用（各母音の`mean`/`sigma`を上書き）

### スコア計算の詳細

- **ガウス分布スコア:** `exp(-(value - optimal)² / (2 * sigma²))`
- **クランプ比スコア:** 範囲内で1.0、範囲外で距離に応じて減衰
- **線形スコア:** `(value - min) / range`で0.0-1.0に正規化

---

## 関連ファイル

- `module/core/VowelClassifier.js`: 母音判定の実装
- `module/core/DataProcessor.js`: 計測値の計算
- `module/core/TemporalFeatureExtractor.js`: 時系列特徴量の抽出
- `module/core/CalibrationManager.js`: キャリブレーション管理
- `docs/VOWEL_DETECTION_LOGIC.md`: 概要とパイプライン

