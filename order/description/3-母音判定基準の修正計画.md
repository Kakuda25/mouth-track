# 母音判定基準の修正計画

## 現状の問題

### 報告された問題

1. **閉口状態で「え」が判定される**
   - カメラ起動し唇をつけている状態（閉口）で「え」の判定が出る

2. **すべての母音が「あ」として判定される**
   - 「あ」は信頼度30%で判定される（正常？）
   - 「い」「う」「え」「お」がすべて「あ」として判定される

## 問題の原因分析

### 1. 閉口判定の閾値が緩すぎる

**現在の閉口判定ロジック:**
```javascript
_isMouthClosed(metrics) {
  // 絶対閾値: openness <= 0.02 → 閉口
  // 厚み比率: openness <= 0.03 && thicknessRatio > 0.25 → 閉口
  // デフォルト閾値: openness <= 0.015 → 閉口
  // 例外: openness <= 0.025 && aspectRatio > 8.0 → 閉口ではない
}
```

**問題点:**
- `openness <= 0.025`かつ`aspectRatio > 8.0`の場合、閉口判定を回避する例外がある
- 「え」の`openness.min`は`0.03`なので、`openness = 0.025-0.03`の範囲で閉口判定を通過してしまう
- 閉口に近い状態でも「え」のスコアが高くなる可能性がある

### 2. 「あ」のスコア計算が他の母音より高くなりすぎている

**現在の「あ」のスコア計算:**
```javascript
_scoreForA(metrics) {
  // openness: 65% (最重要)
  // aspectRatio: 25%
  // area: 10%
  // ペナルティ: openness < 0.06 → スコア × 0.3
}
```

**問題点:**
- 「あ」の`openness.optimal`は`0.10`だが、ガウス分布なので`openness = 0.02-0.04`（閉口に近い状態）でも一定のスコアが得られる
- ペナルティは`openness < 0.06`で適用されるが、それでも他の母音より高スコアになる可能性
- 他の母音（い、う、え、お）は閉口に近い状態で強くペナルティがかかるが、「あ」はペナルティが弱い

**各母音のペナルティ条件:**
- **あ**: `openness < 0.06` → ×0.3
- **い**: `aspectRatio < 4.0` → ×0.3, `openness > 0.05` → ×0.5
- **う**: `width > 0.06` → ×0.25, `circularity < 0.35` → ×0.5
- **え**: `aspectRatio < 2.0` → ×0.5, `openness < 0.03` → ×0.2, `openness > 0.06` → ×0.5
- **お**: `circularity < 0.38` → ×0.4

**問題の核心:**
- 閉口に近い状態（`openness = 0.02-0.04`）では、「あ」のスコアが他の母音より高くなりやすい
- 「あ」のガウス分布（optimal: 0.10, sigma: 0.03）は、`openness = 0.02`でも約0.01のスコアを生成する
- 他の母音は閉口に近い状態で強くペナルティがかかるが、「あ」はペナルティが弱い

### 3. 閉口判定の例外条件が問題を引き起こしている

**現在の例外条件:**
```javascript
if (openness <= 0.025 && aspectRatio > 8.0) {
  return false; // 閉口ではない
}
```

**問題点:**
- この例外により、閉口に近い状態でも「い」のような横長の口型が判定される可能性がある
- しかし、実際には閉口状態でも`aspectRatio`が高くなる場合がある（唇が横に広がっている）

## 修正計画

### フェーズ1: 閉口判定の強化

#### 1.1 閉口判定の閾値を厳格化

**修正内容:**
```javascript
_isMouthClosed(metrics) {
  // 絶対閾値を下げる: 0.02 → 0.015
  if (openness <= 0.015) {
    return true;
  }

  // 厚み比率判定を強化: 0.03 → 0.025
  if (openness <= 0.025 && thicknessRatio > 0.25) {
    return true;
  }

  // 例外条件を削除または厳格化
  // 削除: if (openness <= 0.025 && aspectRatio > 8.0) return false;
  
  // デフォルト閾値を下げる: 0.015 → 0.012
  const closedOpennessThreshold = this.thresholds.closed?.openness ?? 0.012;
  if (openness <= closedOpennessThreshold) {
    return true;
  }

  return false;
}
```

**変更点:**
- 絶対閾値を`0.02`から`0.015`に下げる
- 厚み比率判定の閾値を`0.03`から`0.025`に下げる
- 例外条件（`aspectRatio > 8.0`）を削除
- デフォルト閾値を`0.015`から`0.012`に下げる

#### 1.2 閉口判定の設定値を更新

**修正内容:**
```javascript
this.thresholds = {
  closed: {
    openness: 0.012,        // 0.015 → 0.012
    opennessRatio: 1.3      // 1.5 → 1.3 (より厳格に)
  },
  // ...
}
```

### フェーズ2: 「あ」のスコア計算の修正

#### 2.1 閉口に近い状態でのペナルティ強化

**修正内容:**
```javascript
_scoreForA(metrics) {
  const { openness = 0, aspectRatio = 0, area = 0 } = metrics;
  const config = this.thresholds.vowels.a;

  const openScore = this._gaussianScore(openness, config.openness.optimal, config.openness.sigma);
  const aspectScore = this._clampedRatio(aspectRatio, config.aspectRatio.min, config.aspectRatio.max, config.aspectRatio.falloffRange);
  const areaScore = Math.min(area / (config.area.max || 0.02), 1.0);

  const combined = (openScore * 0.65) + (aspectScore * 0.25) + (areaScore * 0.1);
  
  // ペナルティを強化
  if (openness < config.openness.penaltyThreshold) {
    // 閉口に近いほど強くペナルティ
    const penaltyFactor = Math.max(0.1, openness / config.openness.penaltyThreshold);
    return combined * penaltyFactor * 0.3;
  }
  
  // 閉口判定を通過したが、まだ小さい場合は軽いペナルティ
  if (openness < 0.08) {
    return combined * 0.7;
  }
  
  return combined;
}
```

**変更点:**
- ペナルティを段階的に適用（閉口に近いほど強く）
- `openness < 0.08`の場合は軽いペナルティ（×0.7）を追加

#### 2.2 「あ」の閾値設定の調整

**修正内容:**
```javascript
a: {
  openness: {
    optimal: 0.10,
    sigma: 0.025,              // 0.03 → 0.025 (より狭く)
    penaltyThreshold: 0.08      // 0.06 → 0.08 (より厳格に)
  },
  aspectRatio: {
    min: 0.8,
    max: 1.8,
    falloffRange: 2.0           // 2.5 → 2.0 (より厳格に)
  },
  area: {
    max: 0.025
  }
}
```

### フェーズ3: 他の母音のスコア計算の調整

#### 3.1 「い」のスコア計算の調整

**修正内容:**
```javascript
_scoreForI(metrics) {
  // ...
  const combined = (aspectScore * 0.45) + (opennessScore * 0.25) + (widthScore * 0.15) + (cornerScore * 0.1) + (lipScore * 0.05);
  
  // ペナルティを強化
  if (aspectRatio < config.aspectRatio.min) return combined * 0.2;  // 0.3 → 0.2
  if (openness > config.openness.penaltyThreshold) return combined * 0.3;  // 0.5 → 0.3
  
  // 閉口に近い場合は追加ペナルティ
  if (openness < 0.04) {
    return combined * 0.5;
  }
  
  return combined;
}
```

#### 3.2 「う」のスコア計算の調整

**修正内容:**
```javascript
_scoreForU(metrics) {
  // ...
  const combined = (widthScore * 0.3) + (circularityScore * 0.3) + (opennessScore * 0.2) + (aspectScore * 0.1) + (protrusionScore * 0.1);
  
  // ペナルティを強化
  if (width > config.width.penaltyThreshold) return combined * 0.15;  // 0.25 → 0.15
  if (circularity < config.circularity.penaltyThreshold) return combined * 0.3;  // 0.5 → 0.3
  
  // 閉口に近い場合は追加ペナルティ
  if (openness < 0.04) {
    return combined * 0.4;
  }
  
  return combined;
}
```

#### 3.3 「え」のスコア計算の調整

**修正内容:**
```javascript
_scoreForE(metrics) {
  // ...
  const combined = (aspectScore * 0.35) + (opennessScore * 0.3) + (widthScore * 0.15) + (cornerScore * 0.1) + (lipGapScore * 0.1);
  
  // ペナルティを強化
  if (aspectRatio < config.aspectRatio.penaltyThreshold) return combined * 0.3;  // 0.5 → 0.3
  if (openness < config.openness.min) return combined * 0.1;  // 0.2 → 0.1 (より強く)
  if (openness > config.openness.max) return combined * 0.3;  // 0.5 → 0.3
  
  // 閉口に近い場合は追加ペナルティ
  if (openness < 0.04) {
    return combined * 0.3;
  }
  
  return combined;
}
```

#### 3.4 「お」のスコア計算の調整

**修正内容:**
```javascript
_scoreForO(metrics) {
  // ...
  const combined = (circularityScore * 0.35) + (thicknessScore * 0.25) + (opennessScore * 0.15) + (widthScore * 0.15) + (protrusionScore * 0.1);
  
  // ペナルティを強化
  if (circularity < config.circularity.penaltyThreshold) return combined * 0.2;  // 0.4 → 0.2
  
  // 閉口に近い場合は追加ペナルティ
  if (openness < 0.05) {
    return combined * 0.4;
  }
  
  return combined;
}
```

### フェーズ4: 最小スコア閾値の調整

#### 4.1 最大スコア閾値の見直し

**現在:**
```javascript
if (maxScore < 0.3) {
  return this._createEmptyResult();
}
```

**修正案:**
```javascript
// 閉口に近い状態では、より高いスコアを要求
const minScoreThreshold = metrics.openness < 0.05 ? 0.5 : 0.3;
if (maxScore < minScoreThreshold) {
  return this._createEmptyResult();
}
```

## 実装順序

### ステップ1: 閉口判定の強化（最優先）
1. `_isMouthClosed`メソッドの修正
2. `closed`閾値の更新
3. テスト: 閉口状態で「え」が判定されないことを確認

### ステップ2: 「あ」のスコア計算の修正
1. `_scoreForA`メソッドの修正
2. 「あ」の閾値設定の調整
3. テスト: 閉口に近い状態で「あ」が判定されないことを確認

### ステップ3: 他の母音のスコア計算の調整
1. 「い」「う」「え」「お」のスコア計算を順次修正
2. テスト: 各母音が正しく判定されることを確認

### ステップ4: 最小スコア閾値の調整
1. 最大スコア閾値の動的調整を実装
2. テスト: 全体的な判定精度を確認

## 期待される効果

### 修正後の動作

1. **閉口判定の改善:**
   - 閉口状態（唇をつけている状態）で「え」が判定されなくなる
   - 閉口判定の精度が向上

2. **「あ」の誤検出の削減:**
   - 閉口に近い状態で「あ」が判定されなくなる
   - 他の母音が正しく判定されるようになる

3. **全体的な判定精度の向上:**
   - 各母音が適切な条件で判定される
   - 誤検出が減少

## テスト計画

### テストケース1: 閉口状態の判定
- **条件**: カメラ起動し、唇をつけている状態
- **期待結果**: 「閉口」が判定される（他の母音が判定されない）

### テストケース2: 各母音の判定
- **条件**: 各母音を発音
- **期待結果**: 
  - 「あ」: 信頼度が適切（30%以上）
  - 「い」「う」「え」「お」: それぞれ正しく判定される

### テストケース3: 遷移状態の判定
- **条件**: 母音間の遷移
- **期待結果**: 遷移中は信頼度が下がる（遷移ペナルティが適用される）

## 注意事項

1. **段階的な実装:**
   - 一度にすべてを変更せず、フェーズごとに実装・テストする
   - 各フェーズで動作確認を行う

2. **閾値の調整:**
   - 閾値は実際の計測値に基づいて調整する必要がある
   - ユーザーごとに最適値が異なる可能性がある

3. **キャリブレーションの重要性:**
   - キャリブレーションを実施することで、ユーザー固有の最適値を設定できる
   - キャリブレーション未実施時は、デフォルト値で動作

4. **ログの記録:**
   - 修正前後の計測値と判定結果を記録
   - 問題が発生した場合の原因調査に活用

## 関連ファイル

- `module/core/VowelClassifier.js`: 母音判定の実装
- `order/description/2-母音検知の数値調整とドキュメント作成.md`: 詳細仕様

