# 母音判定基準の再修正計画

## 修正後の新たな問題

### 報告された問題

1. **閉口状態で判定なし（正常）**
   - カメラ起動し唇をつけている状態で判定なし
   - これは期待通りの動作（閉口判定が正しく機能している）

2. **すべての母音が判定されない**
   - 「あ」としてしか判定されない
   - 「い」「う」「え」「お」が判定されない

## 問題の原因分析

### 1. 閉口判定が厳格すぎる可能性

**現在の閉口判定ロジック:**
```javascript
_isMouthClosed(metrics) {
  // 絶対閾値: openness <= 0.015 → 閉口
  if (openness <= 0.015) {
    return true;
  }

  // 厚み比率: openness <= 0.025 && thicknessRatio > 0.25 → 閉口
  if (openness <= 0.025 && thicknessRatio > 0.25) {
    return true;
  }

  // キャリブレーション基準: openness <= baseline.openness * 1.3 → 閉口
  // デフォルト閾値: openness <= 0.012 → 閉口
}
```

**問題点:**
- 閉口判定は正しく機能しているが、他の母音の判定が厳しすぎる可能性がある
- 閉口判定を通過した後、母音判定で弾かれている

### 2. ペナルティが強すぎる

**修正後のペナルティ:**
- **い**: `aspectRatio < 4.0` → ×0.2, `openness > 0.05` → ×0.3, `openness < 0.04` → ×0.5
- **う**: `width > 0.06` → ×0.15, `circularity < 0.35` → ×0.3, `openness < 0.04` → ×0.4
- **え**: `aspectRatio < 2.0` → ×0.3, `openness < 0.03` → ×0.1, `openness > 0.06` → ×0.3, `openness < 0.04` → ×0.3
- **お**: `circularity < 0.38` → ×0.2, `openness < 0.05` → ×0.4

**問題点:**
- ペナルティが重複して適用される場合がある
- 例: 「い」で`openness < 0.04`の場合、複数のペナルティが適用される可能性
- 結果として、スコアが極端に低くなり、最小スコア閾値（0.3または0.5）を下回る

### 3. 最小スコア閾値が高すぎる

**現在の最小スコア閾値:**
```javascript
const minScoreThreshold = metrics.openness < 0.05 ? 0.5 : 0.3;
if (maxScore < minScoreThreshold) {
  return this._createEmptyResult();
}
```

**問題点:**
- `openness < 0.05`の場合、最小スコア閾値が`0.5`になる
- これは非常に高い閾値で、ほとんどの母音が弾かれる可能性がある
- 「あ」以外の母音は、ペナルティにより`0.5`を下回りやすい

### 4. 「あ」のペナルティが相対的に弱い

**現在の「あ」のペナルティ:**
```javascript
if (openness < config.openness.penaltyThreshold) { // 0.08
  const penaltyFactor = Math.max(0.1, openness / config.openness.penaltyThreshold);
  return combined * penaltyFactor * 0.3;
}

if (openness < 0.08) {
  return combined * 0.7;
}
```

**問題点:**
- `openness = 0.04`の場合、`penaltyFactor = 0.5`、最終スコア = `combined * 0.5 * 0.3 = combined * 0.15`
- しかし、他の母音は`openness < 0.04`で×0.3～×0.5のペナルティが追加される
- 結果として、「あ」のスコアが相対的に高くなる

## 修正計画

### フェーズ1: 最小スコア閾値の緩和

#### 1.1 動的閾値の調整

**現在:**
```javascript
const minScoreThreshold = metrics.openness < 0.05 ? 0.5 : 0.3;
```

**修正案:**
```javascript
// より緩やかな閾値に変更
const minScoreThreshold = metrics.openness < 0.03 ? 0.4 : 0.25;
```

**変更点:**
- `openness < 0.03`（より閉口に近い状態）で閾値を上げる
- 閾値を`0.5`→`0.4`、`0.3`→`0.25`に下げる

### フェーズ2: ペナルティの調整

#### 2.1 「い」のペナルティ調整

**現在:**
```javascript
if (aspectRatio < config.aspectRatio.min) return combined * 0.2;
if (openness > config.openness.penaltyThreshold) return combined * 0.3;
if (openness < 0.04) {
  return combined * 0.5;
}
```

**修正案:**
```javascript
if (aspectRatio < config.aspectRatio.min) return combined * 0.25;
if (openness > config.openness.penaltyThreshold) return combined * 0.4;
if (openness < 0.035) {
  return combined * 0.6;
}
```

**変更点:**
- ペナルティを緩和（0.2→0.25、0.3→0.4、0.5→0.6）
- 閉口に近い状態の閾値を`0.04`→`0.035`に下げる

#### 2.2 「う」のペナルティ調整

**現在:**
```javascript
if (width > config.width.penaltyThreshold) return combined * 0.15;
if (circularity < config.circularity.penaltyThreshold) return combined * 0.3;
if (openness < 0.04) {
  return combined * 0.4;
}
```

**修正案:**
```javascript
if (width > config.width.penaltyThreshold) return combined * 0.2;
if (circularity < config.circularity.penaltyThreshold) return combined * 0.4;
if (openness < 0.035) {
  return combined * 0.5;
}
```

**変更点:**
- ペナルティを緩和（0.15→0.2、0.3→0.4、0.4→0.5）
- 閉口に近い状態の閾値を`0.04`→`0.035`に下げる

#### 2.3 「え」のペナルティ調整

**現在:**
```javascript
if (aspectRatio < config.aspectRatio.penaltyThreshold) return combined * 0.3;
if (openness < config.openness.min) return combined * 0.1;
if (openness > config.openness.max) return combined * 0.3;
if (openness < 0.04) {
  return combined * 0.3;
}
```

**修正案:**
```javascript
if (aspectRatio < config.aspectRatio.penaltyThreshold) return combined * 0.4;
if (openness < config.openness.min) return combined * 0.15;
if (openness > config.openness.max) return combined * 0.4;
if (openness < 0.035) {
  return combined * 0.4;
}
```

**変更点:**
- ペナルティを緩和（0.3→0.4、0.1→0.15）
- 閉口に近い状態の閾値を`0.04`→`0.035`に下げる
- 閉口に近い状態のペナルティを`0.3`→`0.4`に緩和

#### 2.4 「お」のペナルティ調整

**現在:**
```javascript
if (circularity < config.circularity.penaltyThreshold) return combined * 0.2;
if (openness < 0.05) {
  return combined * 0.4;
}
```

**修正案:**
```javascript
if (circularity < config.circularity.penaltyThreshold) return combined * 0.3;
if (openness < 0.045) {
  return combined * 0.5;
}
```

**変更点:**
- ペナルティを緩和（0.2→0.3、0.4→0.5）
- 閉口に近い状態の閾値を`0.05`→`0.045`に下げる

### フェーズ3: 「あ」のペナルティ調整（バランス調整）

#### 3.1 「あ」のペナルティを若干強化

**現在:**
```javascript
if (openness < config.openness.penaltyThreshold) { // 0.08
  const penaltyFactor = Math.max(0.1, openness / config.openness.penaltyThreshold);
  return combined * penaltyFactor * 0.3;
}

if (openness < 0.08) {
  return combined * 0.7;
}
```

**修正案:**
```javascript
if (openness < config.openness.penaltyThreshold) { // 0.08
  const penaltyFactor = Math.max(0.15, openness / config.openness.penaltyThreshold);
  return combined * penaltyFactor * 0.35;
}

if (openness < 0.08) {
  return combined * 0.75;
}
```

**変更点:**
- `penaltyFactor`の最小値を`0.1`→`0.15`に上げる
- ペナルティ倍率を`0.3`→`0.35`に上げる
- 軽いペナルティを`0.7`→`0.75`に緩和

### フェーズ4: 閉口判定の微調整

#### 4.1 閉口判定の閾値を若干緩和

**現在:**
```javascript
if (openness <= 0.015) {
  return true;
}

if (openness <= 0.025 && thicknessRatio > 0.25) {
  return true;
}

const closedOpennessThreshold = this.thresholds.closed?.openness ?? 0.012;
```

**修正案:**
```javascript
if (openness <= 0.012) {
  return true;
}

if (openness <= 0.02 && thicknessRatio > 0.25) {
  return true;
}

const closedOpennessThreshold = this.thresholds.closed?.openness ?? 0.012;
```

**変更点:**
- 絶対閾値を`0.015`→`0.012`に下げる（より厳格に）
- 厚み比率判定の閾値を`0.025`→`0.02`に下げる（より厳格に）
- これにより、閉口判定を通過する範囲が狭くなり、母音判定の機会が増える

## 実装順序

### ステップ1: 最小スコア閾値の緩和（最優先）
1. 最小スコア閾値を`0.5`→`0.4`、`0.3`→`0.25`に変更
2. テスト: 各母音が判定されることを確認

### ステップ2: ペナルティの緩和
1. 「い」「う」「え」「お」のペナルティを順次緩和
2. テスト: 各母音が正しく判定されることを確認

### ステップ3: 「あ」のペナルティ調整
1. 「あ」のペナルティを若干強化してバランスを取る
2. テスト: 「あ」が過度に判定されないことを確認

### ステップ4: 閉口判定の微調整（必要に応じて）
1. 閉口判定の閾値を微調整
2. テスト: 閉口判定と母音判定のバランスを確認

## 期待される効果

### 修正後の動作

1. **閉口判定の維持:**
   - 閉口状態（唇をつけている状態）で「判定なし」または「閉口」が判定される
   - 閉口判定の精度は維持

2. **母音判定の改善:**
   - 「い」「う」「え」「お」が正しく判定されるようになる
   - 各母音のスコアが最小閾値を超えるようになる

3. **「あ」の判定精度の維持:**
   - 「あ」が過度に判定されないようにバランスを取る
   - 他の母音との区別が明確になる

## テスト計画

### テストケース1: 閉口状態の判定
- **条件**: カメラ起動し、唇をつけている状態
- **期待結果**: 「判定なし」または「閉口」が判定される

### テストケース2: 各母音の判定
- **条件**: 各母音を発音
- **期待結果**: 
  - 「あ」: 正しく判定される
  - 「い」: 正しく判定される（「あ」として判定されない）
  - 「う」: 正しく判定される（「あ」として判定されない）
  - 「え」: 正しく判定される（「あ」として判定されない）
  - 「お」: 正しく判定される（「あ」として判定されない）

### テストケース3: スコアの確認
- **条件**: 各母音を発音し、スコアを確認
- **期待結果**: 
  - 各母音のスコアが最小閾値（0.25または0.4）を超える
  - 最大スコアの母音が正しく選択される

## 注意事項

1. **段階的な実装:**
   - 一度にすべてを変更せず、ステップごとに実装・テストする
   - 各ステップで動作確認を行う

2. **閾値の調整:**
   - 閾値は実際の計測値に基づいて調整する必要がある
   - ユーザーごとに最適値が異なる可能性がある

3. **ペナルティのバランス:**
   - ペナルティを緩和しすぎると、誤検出が増える可能性がある
   - 各母音のバランスを見ながら調整する

4. **ログの記録:**
   - 修正前後の計測値と判定結果を記録
   - 問題が発生した場合の原因調査に活用

## 問題の根本原因

### 前回の修正が厳しすぎた

前回の修正では、閉口判定を強化し、各母音のペナルティを強化しました。これにより：

1. **閉口判定は正しく機能**
   - 閉口状態で「え」が判定されなくなった（成功）

2. **母音判定が厳しすぎる**
   - ペナルティが強すぎて、「あ」以外の母音のスコアが低くなりすぎた
   - 最小スコア閾値（0.5）が高すぎて、ほとんどの母音が弾かれた

### 今回の修正の方針

1. **閉口判定は維持**
   - 閉口判定の精度は維持する
   - 必要に応じて微調整

2. **母音判定を緩和**
   - ペナルティを緩和して、各母音のスコアを上げる
   - 最小スコア閾値を下げる

3. **バランスを取る**
   - 「あ」のペナルティを若干強化して、他の母音とのバランスを取る

## 唇の突き出し（lipProtrusion）の判定への組み込み状況

### 現在の実装状況

**計算方法:**
```javascript
// DataProcessor.calculateLipProtrusion()
// 上唇外側のランドマーク（12, 13, 14, 15, 16, 17, 18）のZ座標平均
const avgZ = outerPoints.reduce((sum, p) => sum + (p.z || 0), 0) / outerPoints.length;
return Math.max(0, avgZ);
```

**使用されている母音:**

1. **「う」（u）:**
   - 重み付け: 10%
   - 閾値: `max: 0.012`
   - スコア計算: `Math.min(lipProtrusion / 0.012, 1.0)`
   - 未定義時のデフォルト: `0.4`

2. **「お」（o）:**
   - 重み付け: 10%
   - 閾値: `max: 0.015`
   - スコア計算: `Math.min(lipProtrusion / 0.015, 1.0)`
   - 未定義時のデフォルト: `0.4`

### 問題点

1. **重み付けが低い:**
   - 「う」「お」ともに10%の重み付けしかない
   - 他の特徴量（circularity: 30-35%、width: 15-30%）に比べて影響が小さい

2. **未定義時のデフォルト値が高い:**
   - `lipProtrusion`が取得できない場合、デフォルト値`0.4`が使用される
   - これにより、突き出しが計測できなくてもある程度のスコアが得られる

3. **閾値が小さい:**
   - 「う」: `max: 0.012`（正規化距離）
   - 「お」: `max: 0.015`（正規化距離）
   - これらの値が実際の突き出し度合いに対して適切かどうか不明

4. **Z座標の精度:**
   - MediaPipe FaceMeshのZ座標は、X/Y座標に比べて精度が低い
   - カメラとの距離や角度により変動しやすい

### 改善案

#### 改善1: 重み付けの調整

**「う」の重み付け:**
```javascript
// 現在: (widthScore * 0.3) + (circularityScore * 0.3) + (opennessScore * 0.2) + (aspectScore * 0.1) + (protrusionScore * 0.1)
// 改善案: (widthScore * 0.25) + (circularityScore * 0.25) + (opennessScore * 0.2) + (protrusionScore * 0.2) + (aspectScore * 0.1)
```

**変更点:**
- `lipProtrusion`の重み付けを10%→20%に増加
- `width`と`circularity`を30%→25%に減少

**「お」の重み付け:**
```javascript
// 現在: (circularityScore * 0.35) + (thicknessScore * 0.25) + (opennessScore * 0.15) + (widthScore * 0.15) + (protrusionScore * 0.1)
// 改善案: (circularityScore * 0.3) + (thicknessScore * 0.2) + (protrusionScore * 0.2) + (opennessScore * 0.15) + (widthScore * 0.15)
```

**変更点:**
- `lipProtrusion`の重み付けを10%→20%に増加
- `circularity`を35%→30%に減少
- `thicknessScore`を25%→20%に減少

#### 改善2: 未定義時のデフォルト値の調整

**現在:**
```javascript
const protrusionScore = lipProtrusion ? Math.min(lipProtrusion / config.lipProtrusion.max, 1.0) : 0.4;
```

**改善案:**
```javascript
// lipProtrusionが取得できない場合は、より低いスコアを与える
const protrusionScore = lipProtrusion ? Math.min(lipProtrusion / config.lipProtrusion.max, 1.0) : 0.2;
```

**変更点:**
- デフォルト値を`0.4`→`0.2`に下げる
- 突き出しが計測できない場合のスコアを下げることで、判定精度を向上

#### 改善3: 閾値の調整（実測値に基づく）

**現在の閾値:**
- 「う」: `max: 0.012`
- 「お」: `max: 0.015`

**調整の方針:**
- 実際の計測値を確認し、適切な閾値に調整する
- 「お」の方が「う」より突き出しが大きい傾向があるため、閾値の差を維持

#### 改善4: Z座標の精度向上（代替案）

**問題:**
- Z座標の精度が低い

**代替案:**
- 唇の厚みと幅の比率を併用
- 突き出している場合、上唇と下唇の厚みが増加する傾向がある
- `thicknessRatio`（既に「お」で使用）を活用

### 再修正計画への追加

#### フェーズ5: 唇の突き出し判定の強化

##### 5.1 「う」のスコア計算の調整

**現在:**
```javascript
const combined = (widthScore * 0.3) + (circularityScore * 0.3) + (opennessScore * 0.2) + (aspectScore * 0.1) + (protrusionScore * 0.1);
const protrusionScore = lipProtrusion ? Math.min(lipProtrusion / config.lipProtrusion.max, 1.0) : 0.4;
```

**修正案:**
```javascript
const combined = (widthScore * 0.25) + (circularityScore * 0.25) + (opennessScore * 0.2) + (protrusionScore * 0.2) + (aspectScore * 0.1);
const protrusionScore = lipProtrusion ? Math.min(lipProtrusion / config.lipProtrusion.max, 1.0) : 0.2;
```

##### 5.2 「お」のスコア計算の調整

**現在:**
```javascript
const combined = (circularityScore * 0.35) + (thicknessScore * 0.25) + (opennessScore * 0.15) + (widthScore * 0.15) + (protrusionScore * 0.1);
const protrusionScore = lipProtrusion ? Math.min(lipProtrusion / config.lipProtrusion.max, 1.0) : 0.4;
```

**修正案:**
```javascript
const combined = (circularityScore * 0.3) + (thicknessScore * 0.2) + (protrusionScore * 0.2) + (opennessScore * 0.15) + (widthScore * 0.15);
const protrusionScore = lipProtrusion ? Math.min(lipProtrusion / config.lipProtrusion.max, 1.0) : 0.2;
```

### 実装の優先順位

1. **ステップ1-4（既存の再修正計画）を先に実装**
   - 最小スコア閾値の緩和
   - ペナルティの緩和
   - 「あ」のペナルティ調整
   - 閉口判定の微調整

2. **ステップ5（唇の突き出し判定の強化）は後で実装**
   - 既存の修正で母音判定が改善された後に実装
   - 実測値を確認しながら調整

### 注意事項

1. **Z座標の精度:**
   - MediaPipe FaceMeshのZ座標は精度が低いため、過度に依存しない
   - 他の特徴量とのバランスを取る

2. **カメラとの距離:**
   - Z座標はカメラとの距離により変動する
   - 顔スケールで正規化されているが、完全ではない

3. **実測値の確認:**
   - 実際に「う」「お」を発音した際の`lipProtrusion`値を確認
   - 閾値が適切かどうかを検証

## 関連ファイル

- `module/core/VowelClassifier.js`: 母音判定の実装
- `module/core/DataProcessor.js`: `lipProtrusion`の計算
- `order/description/3-母音判定基準の修正計画.md`: 前回の修正計画
- `order/description/2-母音検知の数値調整とドキュメント作成.md`: 詳細仕様

